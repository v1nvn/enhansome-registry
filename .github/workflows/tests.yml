name: 'Shell Script Tests'

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'tests/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run ShellCheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          for script in scripts/*.sh scripts/lib/*.sh; do
            shellcheck -x --severity=warning "$script"
          done

  tests:
    name: Run bashunit tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install bashunit
        run: |
          curl -s https://bashunit.typeddevs.com/install.sh | bash
          echo "$PWD/lib" >> $GITHUB_PATH

      - name: Run tests
        run: |
          bashunit tests/

      - name: Run tests with verbose output
        if: failure()
        run: |
          VERBOSE=true bashunit tests/

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.shellcheck.result == 'failure' ||
          needs.tests.result == 'failure'
        run: exit 1
