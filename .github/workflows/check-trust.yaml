name: 'Check trusted author'

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'allowlist.txt'

permissions:
  pull-requests: read

env:
  TRUSTED_USERS: "v1nvn"

jobs:
  check-trust:
    runs-on: ubuntu-latest
    steps:
      - name: Remove trusted-author label
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --remove-label "trusted-author" 2>/dev/null || true

      - name: Check if author is trusted
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          if echo "$TRUSTED_USERS" | grep -qFx "$PR_AUTHOR"; then
            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --add-label "trusted-author"
            echo "Trusted author: $PR_AUTHOR â€” trusted-author label added"
          else
            echo "Author $PR_AUTHOR is not in trusted users list"
          fi
