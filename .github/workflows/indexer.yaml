name: 'Build and Index Awesome List Data'

on:
  workflow_dispatch:
  schedule:
    # Run daily at 5:00 AM UTC
    - cron: '0 5 * * *'

permissions:
  contents: write

jobs:
  # This job reads the allowlist and prepares a JSON array for the matrix strategy.
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.set-matrix.outputs.json }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Matrix from allowlist.txt
        id: set-matrix
        env:
          MODE: matrix
          GITHUB_OUTPUT: ${{ github.output }}
        run: ./scripts/indexer.sh

  # This job runs in parallel for every entry in the allowlist.
  fetch-and-validate:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      # Do not cancel other jobs if one fails
      fail-fast: false
      matrix:
        # Use the JSON array generated by the previous job
        target: ${{ fromJSON(needs.setup-matrix.outputs.targets) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Target Path
        id: parse
        env:
          MODE: parse
          TARGET: ${{ matrix.target }}
          GITHUB_OUTPUT: ${{ github.output }}
        run: ./scripts/indexer.sh

      - name: Fetch and Validate Data File
        env:
          MODE: fetch
          REPO: ${{ steps.parse.outputs.repo }}
          FILE_PATH: ${{ steps.parse.outputs.file_path }}
          SAFE_FILENAME: ${{ steps.parse.outputs.safe_filename }}
        run: ./scripts/indexer.sh

      - name: Upload Validated JSON as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.parse.outputs.safe_filename }}
          path: ${{ steps.parse.outputs.safe_filename }}
          retention-days: 1

  aggregate-and-commit:
    needs: fetch-and-validate
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download all JSON artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./temp-data

      - name: Organize and Commit Data
        env:
          MODE: aggregate
          TEMP_DIR: ./temp-data
          DATA_DIR: ./data
        run: ./scripts/indexer.sh

      - name: Commit files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): Daily data aggregation"
          file_pattern: 'data/*.json'
          commit_user_name: Enhansome Bot
          commit_user_email: bot@enhansome.dev
          commit_author: Enhansome Bot <bot@enhansome.dev>
